---
title: "Simulation results"
author: "Andrew Mertens"
date: '2022-07-19'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}

source(here::here("0_config.R"))
source(paste0(here::here(),"/0_ltmle_Estimate_update.R"))
try(source(paste0(here::here(),"/simulation study/0_simulation_functions.R")))
plotdf <- readRDS(file=paste0(here::here(),"/results/compiled_simulatation_results.rds"))

library(knitr)

#--------------------------------
# Calc bias, variance, and MSE
#--------------------------------

#relative scale methods:
#https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/s12874-018-0519-5


#plotdf <- plotdf[!grepl("common outcome",plotdf$analysis),] 
plotdf <- plotdf[!grepl(" ic",plotdf$analysis),] 


plotdf <- plotdf[!grepl("common outcome",plotdf$analysis),] 
plotdf <- plotdf[!grepl(" ic",plotdf$analysis),] 

#temp drop extreme outliers
plotdf <- plotdf %>% filter(!is.na(ate)) %>% subset(., select = -c(estimate, std.dev, CI.2.5., CI.97.5.)) %>% rename(estimate= ate, std.dev= ate.sd, CI.2.5.=ate.ci.lb, CI.97.5.=ate.ci.ub)
#plotdf$true.RD <- (-0.030783    )

perf_tab <- plotdf %>% group_by(analysis) %>%
  mutate(variance=mean((estimate-mean(estimate))^2),
         o.ci.lb = estimate - 1.96 * sqrt(variance),
         o.ci.ub = estimate + 1.96 * sqrt(variance)) %>%
  summarize(
    bias=mean((estimate))-(true.RD),
    variance=mean((estimate-mean(estimate))^2),
    mse = bias^2 + variance,
    bias_se_ratio= bias/sqrt(variance),
    coverage=mean(CI.2.5.<=true.RD & true.RD<=CI.97.5.)*100,
    #oracle coverage
    o.coverage=mean(o.ci.lb<=true.RD & true.RD<= o.ci.ub)*100,
    mean_ci_width=mean((CI.97.5.)-(CI.2.5.)),
    power=mean((CI.2.5. > 0 & CI.97.5.>0)|(CI.2.5. < 0 & CI.97.5.<0))*100,
    o.power=mean((o.ci.lb > 0 & o.ci.ub>0)|(o.ci.lb < 0 & o.ci.ub<0))*100
    ) %>%
  distinct()

res <- perf_tab #%>%  arrange(mse)

kable(res, digits =6)


#Add head-to-head power. And calculate oracle power. 


# #--------------------------------
# # Plots
# #--------------------------------
# 
set.seed(123)
ggplot(plotdf, aes(y=analysis, x=estimate)) +
  geom_jitter(width=0, height=0.05, alpha=0.75) +
  geom_vline(xintercept = 0) +
  geom_vline(aes(xintercept = true.RD), linetype="dashed") 




ggplot(plotdf, aes(x=estimate)) +
  facet_wrap(~analysis) +
  geom_density() +
  geom_vline(xintercept = 0) +
  geom_vline(aes(xintercept = true.RD), linetype="dashed") + theme_bw()


```
